# Миграция с JSON на SQLite

## Обзор изменений

Проект был успешно переведен с хранения данных в JSON файлах на использование базы данных SQLite. Это изменение повышает производительность, надежность и масштабируемость приложения.

## Что было сделано

1. Создана структура базы данных SQLite с таблицами для всех сущностей:
   - Пользователи (users)
   - Специалисты (specialists)
   - Услуги (services)
   - Записи (appointments)
   - Статьи (articles)
   - и другие вспомогательные таблицы

2. Реализованы адаптеры для работы с базой данных в директории `src/database/adapters/`

3. Все API маршруты обновлены для работы с SQLite вместо JSON файлов

4. Создан скрипт для очистки старых JSON файлов (`src/scripts/cleanup-old-json-db.js`)

5. Добавлены механизмы для предотвращения автоматического создания JSON файлов

## Структура базы данных

База данных SQLite хранится в файле `database.sqlite` в корне проекта. Схема базы данных определена в файле `src/database/schema.ts`.

## Как работать с базой данных

### Инициализация базы данных

База данных инициализируется автоматически при запуске приложения. В API маршрутах используется функция `initDB()` из модуля `src/app/api/db`.

```typescript
import { initDB } from '@/app/api/db';

// Инициализируем базу данных SQLite
initDB();
```

### Доступ к данным

Для доступа к данным используются адаптеры из директории `src/database/adapters/`:

```typescript
import { usersAdapter, servicesAdapter, specialistsAdapter } from '@/database/adapters';

// Получение всех пользователей
const users = usersAdapter.getAll();

// Получение услуги по ID
const service = servicesAdapter.getById(serviceId);

// Создание нового специалиста
const newSpecialist = specialistsAdapter.create({
  firstName: 'Иван',
  lastName: 'Иванов',
  // другие поля...
});
```

## Обслуживание базы данных

### Резервное копирование

Рекомендуется регулярно создавать резервные копии файла базы данных `database.sqlite`. Это можно сделать простым копированием файла.

### Очистка старых JSON файлов

Если вы заметили, что в директории `public/data` или `public/data_backup_json` снова появились JSON файлы, выполните команду:

```bash
npm run cleanup-json
```

Эта команда удалит все старые JSON файлы и создаст специальные файлы для предотвращения их автоматического создания.

### Миграции

Для обновления схемы базы данных можно использовать команду:

```bash
npm run migrate
```

Эта команда запустит скрипт миграции, который обновит структуру базы данных без потери данных.

## Устранение неполадок

### Ошибки при запуске приложения

Если при запуске приложения возникают ошибки, связанные с базой данных:

1. Проверьте, что файл `database.sqlite` существует и не поврежден
2. Убедитесь, что у приложения есть права на чтение и запись файла базы данных
3. Попробуйте запустить миграцию базы данных: `npm run migrate`

### Ошибки при работе с API

Если API возвращает ошибки, связанные с базой данных:

1. Проверьте, что в API маршруте вызывается функция `initDB()`
2. Убедитесь, что используются правильные адаптеры из `@/database/adapters`
3. Проверьте консоль сервера на наличие ошибок SQLite

## Заключение

Переход на SQLite значительно улучшил производительность и надежность приложения. Теперь данные хранятся в структурированном виде, что упрощает их обработку и обеспечивает целостность данных. 